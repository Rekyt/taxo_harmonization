---
  title: 'Taxonomic harmonization: workflows'
author: "Emilio Berti"
date: "6/15/2021"
output:
  pdf_document:
  toc: yes
html_document:
  toc: yes
df_print: paged
theme: united
---

```{r, echo=FALSE}
knitr::opts_chunk$set(message = FALSE)
```

## Number of unique species in BioTIME

BioTIME taken as raw file had 44,326 unique taxa. After passing it through `rgnparser` (*gn_parse_tidy()*), 4,734 taxa (11\%) were duplicates. Of the remaining 39,592 taxa, 6,692 did not have *Genus species* nomenclature and were removed. Importantly, the remaining 32,900 taxa did not consist exclusively of *Genus species* taxa, but it was not uncommon to have common names and taxonomic keywords such as *Family fam*. We proceeded with the three workflow (Bogota, Torino, and GBIF only) with the remaining 32,900 taxa that had at least two words in their names, a necessary condition for the taxa to be identified at the species level.

```{r biotime}
library(tidyverse)

biotime <- read_csv("~/Documents/biotime_common.csv")
message("Number of unique taxa in BioTIME: ", length(unique(biotime$BioTIME)))
message("Number of unique taxa in BioTIME after gnparse: ",
        length(unique(biotime$parsed)))
difference <- length(unique(biotime$BioTIME)) - length(unique(biotime$parsed))
message("Difference: ", difference , " | ",
        round(difference / length(unique(biotime$BioTIME)), 4) * 100, "%")
```

```{r one word}
sp_lev <- biotime %>% 
  mutate(species_level = modify(parsed, function(x) {
    len <- str_split(x, " ", simplify = TRUE) %>% length()
    if (len == 1)
      FALSE 
    else 
      TRUE
  }) %>% as.logical()) %>%
  filter(species_level) %>%
  pull(parsed) %>% 
  unique() %>% 
  length()
message("Number of unique binomial taxa after rgnparse: ", sp_lev)
message("Difference: ", length(unique(biotime$parsed)) - sp_lev)
```


```{r load workflow 1, eval=FALSE, echo=FALSE}
# workflow 1 -------
plants <- read_csv("~/Documents/bogota_lcvp.csv") %>% filter(!is.na(lcvp))
fishes <- read_csv("~/Documents/bogota_fishbase.csv") %>% filter(!is.na(fishbase))
birds <- read_csv("~/Documents/bogota_ebird.csv") %>% filter(!is.na(ebird))
gbif <- read_csv("~/Documents/bogota_gbif.csv") %>% filter(!is.na(gbif))
wf1 <- biotime %>%  
  select(-class, -phylum, -BioTIME) %>%
  distinct_all() %>%
  left_join(plants %>% distinct_all()) %>%
  left_join(fishes %>% distinct_all()) %>%
  left_join(birds %>% distinct_all()) %>%
  left_join(gbif %>% distinct_all())
#remove GBIF if another db found something
wf1 <- wf1 %>%
  mutate(remove_gbif = pmap(list(lcvp, fishbase, ebird), 
                            function(x, y, z) {
                              valid <- !is.na(c(x, y, z))
                              if (any(valid))
                                TRUE
                              else 
                                FALSE
                            }) %>% unlist() %>% as.logical()) %>%
  mutate(gbif = modify2(gbif, remove_gbif, function(x, y) {
    if (y)
      NA
    else
      x
  })) %>% 
  select(-remove_gbif)
wf1 <- wf1 %>%
  mutate(conflict = pmap(list(lcvp, fishbase, ebird), 
                         function(x, y, z) {
                           valid <- !is.na(c(x, y, z))
                           if (sum(valid) > 1)
                             TRUE
                           else
                             FALSE
                         }) %>% unlist() %>% as.logical()) %>%
  filter(!conflict) %>%
  select(-conflict)
wf1 <- wf1 %>% 
  mutate(species_level = modify(parsed, function(x) {
    len <- str_split(x, " ", simplify = TRUE) %>% length()
    if (len == 1)
      FALSE 
    else 
      TRUE
  }) %>% as.logical()) %>%
  distinct(parsed, .keep_all = TRUE) %>%
  filter(species_level) %>%
  select(-species_level)
wf1 <- wf1 %>%
  select(-common) %>%
  pivot_longer(cols = 2:5,
               names_to = "step",
               values_to = "matched") %>%
  filter(!is.na(matched)) %>%
  select(-step) %>% 
  mutate(species_level = modify(matched, function(x) {
    len <- str_split(x, " ", simplify = TRUE) %>% length()
    if (len == 1)
      FALSE 
    else 
      TRUE
  }) %>% as.logical()) %>%
  distinct(parsed, .keep_all = TRUE) %>%
  filter(species_level) %>%
  select(-species_level)
```

```{r load results of previous chunk}
wf1 <- read_rds("biotime_results/bogota.rds")
```

```{r workflow 2, eval=FALSE, echo=FALSE}
# workflow 2 ----------
plants <- read_csv("~/Documents/torino_lcvp.csv")
fishes <- read_csv("~/Documents/torino_fishbase.csv")
birds <- read_csv("~/Documents/torino_ebird.csv")
gbif <- read_csv("~/Documents/torino_gbif.csv") %>%
  mutate(species_level = modify(gbif, function(x) {
    len <- str_split(x, " ", simplify = TRUE) %>% length()
    if (len == 1)
      FALSE 
    else 
      TRUE
  }) %>% as.logical()) %>%
  filter(species_level) %>%
  select(-species_level) %>% 
  mutate(species_level = modify(parsed, function(x) {
    len <- str_split(x, " ", simplify = TRUE) %>% length()
    if (len == 1)
      FALSE 
    else 
      TRUE
  }) %>% as.logical()) %>%
  filter(species_level) %>%
  select(-species_level)
wf2 <- biotime %>%  
  select(-class, -phylum, -BioTIME) %>%
  distinct_all() %>%
  left_join(plants %>% distinct_all()) %>%
  left_join(fishes %>% distinct_all()) %>%
  left_join(birds %>% distinct_all()) %>%
  left_join(gbif %>% distinct_all()) %>% 
  mutate(species_level = modify(parsed, function(x) {
    len <- str_split(x, " ", simplify = TRUE) %>% length()
    if (len == 1)
      FALSE 
    else 
      TRUE
  }) %>% as.logical()) %>%
  distinct(parsed, .keep_all = TRUE) %>%
  filter(species_level) %>%
  select(-species_level)
wf2 <- wf2 %>%
  select(-common) %>%
  pivot_longer(cols = 2:5,
               names_to = "step",
               values_to = "matched") %>%
  filter(!is.na(matched)) %>%
  select(-step) %>% 
  mutate(species_level = modify(matched, function(x) {
    len <- str_split(x, " ", simplify = TRUE) %>% length()
    if (len == 1)
      FALSE 
    else 
      TRUE
  }) %>% as.logical()) %>%
  distinct(parsed, .keep_all = TRUE) %>%
  filter(species_level) %>%
  select(-species_level)
```

```{r load results of previous chunk}
wf2 <- read_rds("biotime_results/torino.rds")
```

```{r gbif only, echo=FALSE, eval=FALSE}
gbif <- read_csv("~/Documents/bogota_gbif.csv") %>%
  distinct(parsed, .keep_all = TRUE) %>%
  mutate(species_level = modify(parsed, function(x) {
    len <- str_split(x, " ", simplify = TRUE) %>% length()
    if (len == 1)
      FALSE 
    else 
      TRUE
  }) %>% as.logical()) %>% 
  filter(species_level) %>% 
  select(-species_level) %>% 
  mutate(species_level = modify(gbif, function(x) {
    len <- str_split(x, " ", simplify = TRUE) %>% length()
    if (len == 1)
      FALSE 
    else 
      TRUE
  }) %>% as.logical()) %>%
  distinct(parsed, .keep_all = TRUE) %>%
  filter(species_level) %>%
  select(-species_level)
```

```{r load results of previous chunk}
gbif <- read_rds("biotime_results/gbif.rds")
```

## Comparison Bogota - Torino

```{r bogota vs torino 1}
# bogota
message(
  "Bogota matched ", 
  wf1$parsed %>% 
    unique() %>% 
    length(),
  " names to ",
  wf1$matched %>% 
    unique() %>% 
    length(),
  " unique species."
)
# torino
message(
  "Torino matched ", 
  wf2$parsed %>% 
    unique() %>% 
    length(),
  " names to ",
  wf2$matched %>% 
    unique() %>% 
    length(),
  " unique species."
)

# this gives a list of to which higher groups
# the missing names in Torino belong
wf1 %>% 
  full_join(wf2, by = "parsed", suffix = c("_bogota", "_torino")) %>%
  mutate(matched_bogota = ifelse(is.na(matched_bogota), "NA", matched_bogota),
         matched_torino = ifelse(is.na(matched_torino), "NA", matched_torino)) %>%
  filter(matched_bogota != matched_torino) %>%
  filter(matched_torino == "NA") %>% 
  left_join(biotime) %>% 
  group_by(common) %>% 
  tally()
# this gives the remaining difference
wf1 %>% 
  full_join(wf2, by = "parsed", suffix = c("_bogota", "_torino")) %>%
  mutate(matched_bogota = ifelse(is.na(matched_bogota), "NA", matched_bogota),
         matched_torino = ifelse(is.na(matched_torino), "NA", matched_torino)) %>%
  filter(matched_bogota != matched_torino) %>%
  filter(matched_torino == "NA") %>% 
  left_join(biotime) %>% 
  filter(is.na(common))
```

## Torino vs GBIF

```{r torino vs gbif}
torino <- read_rds("biotime_results/torino.rds")
gbif <- read_rds("biotime_results/gbif.rds")

message(
  "GBIF matched ", 
  gbif$parsed %>% 
    unique() %>% 
    length(),
  " names to ",
  gbif$gbif %>% 
    unique() %>% 
    length(),
  " unique species."
)

# synonyms
syns_torino <- table(table(torino$matched))
syns_gbif <- table(table(gbif$gbif))

sum(syns_gbif[2:length(syns_gbif)] * as.integer(names(syns_gbif))[1:(length(syns_gbif) - 1)])

sum(syns_torino[2:length(syns_torino)] * as.integer(names(syns_torino))[1:(length(syns_torino) - 1)])

reps <- names(which(table(gbif$gbif) > 1))
gbif %>% 
  filter(gbif %in% reps) %>% 
  nrow()
reps <- names(which(table(torino$matched) > 1))
torino %>% 
  filter(matched %in% reps) %>% 
  nrow()

message("Number of unique taxa in GBIF only: ",
        length(unique(gbif$gbif)))
gbif <- gbif %>% 
  mutate(species_level = modify(parsed, function(x) {
    len <- str_split(x, " ", simplify = TRUE) %>% length()
    if (len == 1)
      FALSE 
    else 
      TRUE
  }) %>% as.logical()) %>%
  filter(species_level) %>%
  select(-species_level) %>% 
  mutate(species_level = modify(gbif, function(x) {
    len <- str_split(x, " ", simplify = TRUE) %>% length()
    if (len == 1)
      FALSE 
    else 
      TRUE
  }) %>% as.logical()) %>%
  filter(species_level) %>%
  select(-species_level) 
diff_gbif <- length(unique(gbif$parsed)) - length(unique(gbif$gbif))
naive <- gbif %>% 
  left_join(wf2) %>% 
  distinct(parsed, .keep_all = TRUE) %>%
  mutate(species_level = modify(parsed, function(x) {
    len <- str_split(x, " ", simplify = TRUE) %>% length()
    if (len == 1)
      FALSE 
    else 
      TRUE
  }) %>% as.logical()) %>%
  filter(species_level) %>%
  select(-species_level) %>% 
  transmute(parsed,
            gbif = ifelse(is.na(gbif), "NA", gbif),
            torino = ifelse(is.na(matched), "NA", matched)) %>% 
  mutate(torino = modify(torino, function(x) {
    paste(str_split(x, " ", simplify = TRUE)[1:2], collapse = " ")
  }),
  torino = gsub("NA NA", "NA", torino))
naive %>% 
  filter(gbif != torino) %>% 
  distinct_all()
naive %>% 
  filter(gbif != torino) %>% 
  filter(torino == "NA")
```

GBIF only harmonized species list had 30,688 unique species names (*Genus species*), whereas Torino had 29,827 (difference = 861 species).

```{r duplicates}
naive %>% 
  filter(gbif != "NA") %>% 
  pull(gbif) %>% 
  unique() %>% 
  length()
naive %>% 
  filter(torino != "NA") %>% 
  pull(torino) %>% 
  unique() %>% 
  length()
```
Part of the difference is accounted by taxa-specific references identifying synonyms that are considered unique species in GBIF; in total, 688 parsed species names were identified as synonyms in Torino (repeated in total 1,409 times), whereas none was found in GBIF.

```{r synonyms}
naive %>% 
  filter(gbif != "NA") %>% 
  distinct_all() %>% 
  select(-torino) %>% 
  pull(parsed) %>% 
  table() %>%
  table()
naive %>% 
  filter(torino != "NA") %>% 
  select(-gbif) %>% 
  distinct_all() %>% 
  pull(torino) %>% 
  table() %>% 
  table()
```
In summary, of the 44,326 original unique species names, around 11\% were the same species with synthatic differences in the way they were written, resolved by passing the species names to `rgnparser`. An additional 15\% were removed from harmonization due to not having binomial names, as we were interested in resolving names of taxa at the species level. Both workflows we ran, identified around 92\% of the remaining species names, with marginal differences between the harmonized taxonomies. Using only GBIF to harmonize the list of species names resulted in the highest number of matched. This workflow, however, ignored synonym matching accounted for in the other two workflows, with potential consequences on downstream analyses such as species richness and species turnover across sites. 
Of the original raw names in BioTIME, however, only 81\% of the species names already corrected for spelling and syntax were matched, due to the presence of many taxa with taxonomic information only for taxonomic ranks higher than the species level. Despite this relatively low proportion, both our suggested workflows managed to harmonized around 98\% of the taxa names that referred to a species (i.e. *Genus species*). Importantly, as we used taxa-specific references when available, the harmonized taxonomy is in line with current taxonomic hypotheses. For taxa that did not have specific references, using GBIF might have resulted in overestimating the number of unique species (see above); however, as there are currently no tools in R to access taxa-specific references, this could not have been solved otherwise, which stress the importance of developing such tools in the future.


```{r names lost during harmonization}
tibble(steps = c("original",
                 "gnparser",
                 "gnparser + only binomial names",
                 "gnparser + bogota",
                 "gnparser + torino",
                 "gnparser + GBIF"),
       `n unique taxa` = c(44326,
                           44326 - diff_parsed,
                           32900,
                           32900 - diff_bogota,
                           32900 - diff_torino,
                           32900 - diff_gbif),
       `difference from raw` = c(0,
                                 diff_parsed,
                                 diff_parsed + 6692,
                                 diff_parsed + diff_bogota,
                                 diff_parsed + diff_torino,
                                 diff_parsed + diff_gbif),
       `difference from gnparser` = c(NA,
                                      0,
                                      6692,
                                      diff_bogota,
                                      diff_torino,
                                      diff_gbif))
```

Here, we have shown three taxonomic harmonization workflow, two coherent with our guidelines and a more naive approach that uses only GBIF to harmonize species names. We presented this example not to udnerstate the utility of GBIF in taxonomic harmonization (for instance, its usage in the first step of Torino had very high accuracy), but rather because this naive approach may be particularly attractive to macroecologists that just started working with taxonomic harmonization. Our aim was to provide example workflows that followed our guidelines and start creating a roadmap that places taxonomic tools into their proper places.




